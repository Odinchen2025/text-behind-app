<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Text Mask Tool V5 (Blob Engine)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; touch-action: none; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        
        #canvas-wrapper { 
            position: relative; width: 100vw; height: 60vh; 
            background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        /* è¼‰å…¥å‹•ç•«å±¤ */
        #loading-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .controls { height: 40vh; background: #222; display: flex; flex-direction: column; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 14px; color: #666; border-bottom: 2px solid #333; }
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; font-weight: bold; background: #2a2a2a; }

        input[type=range] { -webkit-appearance: none; background: transparent; height: 30px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; box-shadow: 0 2px 4px black; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loading-layer" class="hidden">
        <div class="spinner"></div>
        <div id="loading-text" class="text-gray-300 font-bold text-sm">è¼‰å…¥ä¸­...</div>
        <button onclick="cancelLoading()" class="mt-4 text-xs text-red-400 border border-red-900 px-3 py-1 rounded">å–æ¶ˆ</button>
    </div>

    <div class="flex justify-between items-center px-4 py-3 bg-gray-900 border-b border-gray-800">
        <span class="font-bold text-gray-400 text-sm">TEXT MASK V5</span>
        <div class="flex gap-2">
            <label class="bg-blue-600 active:bg-blue-700 px-4 py-1.5 rounded text-xs font-bold transition cursor-pointer flex items-center shadow-lg">
                ğŸ“‚ é–‹å•Ÿç…§ç‰‡
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </label>
            <button onclick="saveImage()" class="bg-gray-700 active:bg-gray-600 px-4 py-1.5 rounded text-xs font-bold transition">ğŸ’¾ å­˜åœ–</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="c"></canvas>
    </div>

    <div class="controls">
        <div class="flex">
            <div id="tab-text" onclick="switchMode('text')" class="tab-btn active">1. æ–‡å­—ç·¨è¼¯</div>
            <div id="tab-mask" onclick="switchMode('mask')" class="tab-btn">2. äººç‰©é®ç½©</div>
        </div>

        <div id="panel-text" class="flex-1 p-4 overflow-y-auto space-y-4">
            <button onclick="addText()" class="w-full bg-gray-700 py-3 rounded text-sm font-bold border border-gray-600 active:bg-gray-600">+ æ–°å¢æ–‡å­—</button>
            <div class="space-y-3">
                <input type="text" id="val-text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white text-center" placeholder="é»é¸æ–‡å­—é€²è¡Œä¿®æ”¹">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">é¡è‰²</span>
                    <input type="color" id="val-color" class="w-10 h-10 rounded bg-transparent border-none">
                    <span class="text-xs text-gray-500 ml-2">é€æ˜åº¦</span>
                    <input type="range" id="val-opacity" min="0" max="1" step="0.1" value="1" class="flex-1">
                </div>
            </div>
        </div>

        <div id="panel-mask" class="hidden flex-1 p-4 flex flex-col items-center">
            <div class="text-blue-300 text-xs text-center mb-4 px-4">
                ğŸ‘† ç”¨æ‰‹æŒ‡å¡—æŠ¹<b>äººç‰©å€åŸŸ</b><br>
                <span class="text-gray-500">(è¢«å¡—æŠ¹çš„å€åŸŸå°‡æœƒè“‹åœ¨æ–‡å­—ä¸Šæ–¹)</span>
            </div>
            <div class="flex gap-3 w-full mb-4 px-2">
                <button onclick="undoMask()" class="flex-1 bg-gray-700 py-3 rounded text-sm font-bold">â†©ï¸ æ’¤éŠ·</button>
                <button onclick="resetMask()" class="flex-1 bg-red-900/30 text-red-300 border border-red-900/50 py-3 rounded text-sm font-bold">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div class="w-full px-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>ç­†åˆ·å¤§å°</span>
                    <span id="brush-size-val">30</span>
                </div>
                <input type="range" id="val-brush" min="10" max="100" value="30">
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#111',
            preserveObjectStacking: true,
            selection: false
        });

        let bgImage = null;
        let topMaskLayer = null;
        let maskPaths = [];
        let isMaskMode = false;

        // UI ç¶å®š
        const loadingEl = document.getElementById('loading-layer');
        const loadingText = document.getElementById('loading-text');
        
        function showLoading(msg) {
            loadingText.innerText = msg || "è¼‰å…¥ä¸­...";
            loadingEl.classList.remove('hidden');
        }
        function hideLoading() {
            loadingEl.classList.add('hidden');
        }
        function cancelLoading() { hideLoading(); }

        // é©æ‡‰è¢å¹•
        function fitCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            canvas.setWidth(wrapper.clientWidth);
            canvas.setHeight(wrapper.clientHeight);
        }
        window.addEventListener('resize', fitCanvas);
        setTimeout(fitCanvas, 50);

        // ---------------------------------------------
        // æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ Blob URL è®€å–åœ–ç‰‡ (æ¥µé€Ÿæ¨¡å¼)
        // ---------------------------------------------
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading("è®€å–ç…§ç‰‡ä¸­...");

            // 1. å»ºç«‹ Blob URL (ä¸ä½”ç”¨ JS Heap è¨˜æ†¶é«”)
            const imgUrl = URL.createObjectURL(file);

            fabric.Image.fromURL(imgUrl, function(img) {
                // 2. é‡‹æ”¾ URL è¨˜æ†¶é«”
                URL.revokeObjectURL(imgUrl);

                if (!img) {
                    alert("ç„¡æ³•è§£æåœ–ç‰‡");
                    hideLoading();
                    return;
                }

                // é‡ç½®ç•«å¸ƒ
                canvas.clear();
                maskPaths = [];
                canvas.setBackgroundColor('#111', canvas.renderAll.bind(canvas));

                // 3. æ™ºæ…§ç¸®æ”¾ (é˜²æ­¢æ‰‹æ©Ÿç•¶æ©Ÿ)
                // å¦‚æœåœ–ç‰‡å¤§æ–¼ 2048pxï¼Œç¨å¾®ç¸®å°å®ƒï¼Œé€™æ˜¯æ‰‹æ©Ÿ Canvas çš„å®‰å…¨ç·š
                const maxSafeSize = 2048; 
                if (img.width > maxSafeSize || img.height > maxSafeSize) {
                    img.scaleToWidth(maxSafeSize);
                }

                // è¨ˆç®—é¡¯ç¤ºæ¯”ä¾‹ (Contain)
                const scale = Math.min(
                    canvas.width / (img.width * img.scaleX),
                    canvas.height / (img.height * img.scaleY)
                );

                // è¨­å®šåº•åœ–
                img.set({
                    originX: 'center', originY: 'center',
                    left: canvas.width / 2, top: canvas.height / 2,
                    scaleX: img.scaleX * scale,
                    scaleY: img.scaleY * scale,
                    selectable: false, evented: false
                });

                bgImage = img;
                canvas.add(bgImage);

                // 4. å»ºç«‹é®ç½©å±¤ (è¤‡è£½ä¸€ä»½åº•åœ–æ”¾åœ¨æœ€ä¸Šé¢)
                bgImage.clone(function(cloned) {
                    topMaskLayer = cloned;
                    topMaskLayer.set({
                        selectable: false, evented: false, absolutePositioned: true,
                        // åˆå§‹é®ç½©æ˜¯ç©ºçš„ (å…¨é€æ˜)
                        clipPath: new fabric.Group([], { absolutePositioned: true })
                    });
                    canvas.add(topMaskLayer);
                    
                    // è‡ªå‹•åŠ å€‹æ–‡å­—è®“ç”¨æˆ¶çŸ¥é“æˆåŠŸäº†
                    addText();
                    
                    hideLoading();
                });

            }, { crossOrigin: 'anonymous' }); // ä¿æŒåŒ¿åè·¨åŸŸè¨­å®š
        });

        // ---------------------------------------------
        // æ–‡å­—åŠŸèƒ½
        // ---------------------------------------------
        function addText() {
            if (!bgImage) return;
            const t = new fabric.IText('æ–‡å­—ç‰¹æ•ˆ', {
                left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center',
                fontFamily: 'Noto Sans TC', fill: '#ffffff', fontSize: 60, fontWeight: '900',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 10, offsetX: 5, offsetY: 5 })
            });
            canvas.add(t);
            canvas.setActiveObject(t);
            // ç¢ºä¿é®ç½©å±¤æ°¸é åœ¨æœ€ä¸Šé¢
            if(topMaskLayer) canvas.bringToFront(topMaskLayer);
        }

        const uiText = document.getElementById('val-text');
        const uiColor = document.getElementById('val-color');
        const uiOpacity = document.getElementById('val-opacity');

        function updateUI() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                uiText.value = obj.text;
                uiColor.value = obj.fill;
                uiOpacity.value = obj.opacity;
            }
        }
        canvas.on('selection:created', updateUI);
        canvas.on('selection:updated', updateUI);

        uiText.oninput = () => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set({text: uiText.value}); canvas.requestRenderAll(); }};
        uiColor.oninput = () => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set({fill: uiColor.value}); canvas.requestRenderAll(); }};
        uiOpacity.oninput = () => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set({opacity: parseFloat(uiOpacity.value)}); canvas.requestRenderAll(); }};

        // ---------------------------------------------
        // é®ç½©èˆ‡å¡—æŠ¹åŠŸèƒ½ (Snapseed æ¨¡å¼)
        // ---------------------------------------------
        function switchMode(mode) {
            isMaskMode = (mode === 'mask');
            
            // æ¨£å¼åˆ‡æ›
            document.getElementById('tab-text').className = isMaskMode ? 'tab-btn' : 'tab-btn active';
            document.getElementById('tab-mask').className = isMaskMode ? 'tab-btn active' : 'tab-btn';
            document.getElementById('panel-text').classList.toggle('hidden', isMaskMode);
            document.getElementById('panel-mask').classList.toggle('hidden', !isMaskMode);

            if (isMaskMode) {
                if(!bgImage) { alert("è«‹å…ˆé–‹å•Ÿç…§ç‰‡"); switchMode('text'); return; }
                canvas.discardActiveObject();
                canvas.requestRenderAll();
                
                // è¨­å®šç­†åˆ·ï¼šåŠé€æ˜ç´…è‰²é è¦½
                canvas.isDrawingMode = true;
                const brush = new fabric.PencilBrush(canvas);
                brush.color = "rgba(255, 50, 50, 0.5)"; 
                brush.width = parseInt(document.getElementById('val-brush').value);
                canvas.freeDrawingBrush = brush;
                
                canvas.forEachObject(o => o.selectable = false);
            } else {
                canvas.isDrawingMode = false;
                canvas.forEachObject(o => { if(o.type === 'i-text') o.selectable = true; });
            }
        }

        document.getElementById('val-brush').oninput = (e) => {
            const size = parseInt(e.target.value);
            document.getElementById('brush-size-val').innerText = size;
            if(canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = size;
        };

        // å¡—æŠ¹çµæŸæ™‚çš„è™•ç†
        canvas.on('path:created', function(e) {
            if (!isMaskMode) return;
            const path = e.path;
            canvas.remove(path); // ç§»é™¤ç´…ç·š

            // è¤‡è£½è·¯å¾‘åŠ å…¥é®ç½©ç¾¤çµ„
            path.clone(function(cloned) {
                cloned.set({
                    stroke: 'black', fill: null,
                    strokeWidth: path.strokeWidth, strokeLineCap: 'round', strokeLineJoin: 'round',
                    left: path.left, top: path.top,
                    globalCompositeOperation: 'source-over'
                });
                maskPaths.push(cloned);
                applyMask();
            });
        });

        function applyMask() {
            if (!topMaskLayer) return;
            // çµ„åˆæ‰€æœ‰ç­†è§¸æˆç‚ºå‰ªè£è·¯å¾‘
            const group = new fabric.Group(maskPaths, { absolutePositioned: true, inverted: false });
            topMaskLayer.clipPath = group;
            topMaskLayer.dirty = true;
            canvas.requestRenderAll();
        }

        function undoMask() {
            if (maskPaths.length > 0) { maskPaths.pop(); applyMask(); }
        }
        function resetMask() {
            maskPaths = []; applyMask();
        }

        // ---------------------------------------------
        // å­˜åœ–
        // ---------------------------------------------
        function saveImage() {
            if(!bgImage) return;
            canvas.discardActiveObject();
            canvas.renderAll();
            
            // è¼¸å‡º 2 å€é«˜è§£æåº¦
            const link = document.createElement('a');
            link.href = canvas.toDataURL({ format: 'png', quality: 0.9, multiplier: 2 });
            link.download = 'text_mask_pro.png';
            link.click();
        }

    </script>
</body>
</html>
