<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Text Behind Image Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* ç¦æ­¢ç¶²é é è¨­ç¸®æ”¾ï¼Œå°‡æ‰‹å‹¢ç•™çµ¦ç•«å¸ƒ */
        body { background-color: #000; color: white; touch-action: none; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        #canvas-area { 
            position: relative; width: 100vw; height: 55vh; 
            background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        .controls { height: 45vh; background: #222; display: flex; flex-direction: column; padding-bottom: 20px;}
        
        /* è‡ªå®šç¾©æ»‘æ¡¿ */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4b5563; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="flex justify-between items-center p-3 bg-gray-900 border-b border-gray-800 z-50">
        <span class="font-bold text-gray-400 text-sm">TEXT MASK v2</span>
        <div class="flex gap-2">
            <label class="bg-gray-700 px-3 py-1.5 rounded text-xs font-bold active:scale-95 transition cursor-pointer">
                ğŸ“‚ é–‹å•Ÿç…§ç‰‡
                <input type="file" id="up-img" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImg()" class="bg-blue-600 px-3 py-1.5 rounded text-xs font-bold active:scale-95 transition">ğŸ’¾ å­˜åœ–</button>
        </div>
    </div>

    <div id="canvas-area">
        <canvas id="c"></canvas>
    </div>

    <div class="controls">
        <div class="flex text-center border-b border-gray-700">
            <div id="tab-text" onclick="setMode('text')" class="flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold transition-all">A. æ–‡å­—ç·¨è¼¯</div>
            <div id="tab-mask" onclick="setMode('mask')" class="flex-1 py-3 text-sm text-gray-500 font-bold transition-all">B. é®ç½©å¡—æŠ¹</div>
        </div>

        <div id="panel-text" class="flex-1 p-4 space-y-4 overflow-y-auto">
            <div class="flex justify-between items-center">
                <button onclick="addText()" class="bg-gray-700 w-full py-3 rounded-lg text-sm font-bold active:bg-gray-600">+ æ–°å¢æ–‡å­—</button>
            </div>
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <span class="text-xs w-8 text-gray-400">å…§å®¹</span>
                    <input type="text" id="ipt-text" class="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm" placeholder="é»æ“Šæ–‡å­—ç·¨è¼¯">
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs w-8 text-gray-400">é¡è‰²</span>
                    <input type="color" id="ipt-color" class="w-8 h-8 rounded border-none bg-transparent">
                    <span class="text-xs w-8 text-gray-400 ml-2">é€æ˜</span>
                    <input type="range" id="ipt-opacity" min="0" max="1" step="0.1" value="1" class="flex-1">
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">ğŸ’¡ å–®æŒ‡æ‹–æ›³æ–‡å­—ï¼Œé›™æŒ‡å¯æ—‹è½‰ç¸®æ”¾</p>
        </div>

        <div id="panel-mask" class="hidden flex-1 p-4 space-y-4 flex flex-col items-center">
            <div class="bg-yellow-900/30 text-yellow-500 p-2 rounded text-xs w-full text-center border border-yellow-800">
                ğŸ‘† ç”¨æ‰‹æŒ‡å¡—æŠ¹æƒ³è¦<b>ã€Œæ“‹ä½æ–‡å­—ã€</b>çš„å€åŸŸ (ä¾‹å¦‚äººç‰©)
            </div>
            
            <div class="flex gap-4 w-full justify-center">
                <button onclick="undoMask()" class="flex-1 bg-gray-700 py-3 rounded-lg text-sm font-bold active:scale-95">â†©ï¸ æ’¤éŠ·ä¸€ç­†</button>
                <button onclick="clearMask()" class="flex-1 bg-red-900/50 text-red-300 py-3 rounded-lg text-sm font-bold active:scale-95">ğŸ—‘ï¸ é‡è¨­é®ç½©</button>
            </div>

            <div class="w-full pt-2">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>ç­†åˆ·å¤§å°</span>
                    <span id="brush-val">30</span>
                </div>
                <input type="range" id="ipt-brush" min="5" max="80" value="30" class="w-full">
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Fabric
        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#111',
            preserveObjectStacking: true,
            selection: false // æ‰‹æ©Ÿæ“ä½œå»ºè­°é—œé–‰æ¡†é¸
        });

        let bgImgNode = null; // åŸå§‹åœ–ç‰‡ç‰©ä»¶
        let topLayer = null;  // é ‚å±¤é®ç½©åœ–ç‰‡ (Clone)
        let maskGroup = null; // é®ç½©è·¯å¾‘ç¾¤çµ„
        let maskPaths = [];   // å„²å­˜æ‰€æœ‰çš„ç­†è§¸è·¯å¾‘
        
        // è¢å¹•é©é…
        function resize() {
            const container = document.getElementById('canvas-area');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
        }
        window.addEventListener('resize', resize);
        resize();

        // 1. ä¸Šå‚³ç…§ç‰‡
        document.getElementById('up-img').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                fabric.Image.fromURL(f.target.result, (img) => {
                    canvas.clear();
                    maskPaths = []; // é‡ç½®é®ç½©
                    
                    // ç¸®æ”¾åœ–ç‰‡ä»¥é©æ‡‰ç•«å¸ƒ (Contain)
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    img.set({
                        scaleX: scale,
                        scaleY: scale,
                        left: (canvas.width - img.width * scale) / 2,
                        top: (canvas.height - img.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    bgImgNode = img;
                    canvas.add(bgImgNode);
                    
                    // é å…ˆå»ºç«‹é ‚å±¤é®ç½© (ä¸€é–‹å§‹ä¸å¯è¦‹)
                    initTopLayer();
                });
            };
            reader.readAsDataURL(file);
        };

        // 2. å»ºç«‹ã€Œé ‚å±¤ç…§ç‰‡ã€ç”¨æ–¼é®æ“‹æ–‡å­—
        function initTopLayer() {
            if(!bgImgNode) return;
            bgImgNode.clone((cloned) => {
                topLayer = cloned;
                topLayer.set({
                    selectable: false,
                    evented: false,
                    absolutePositioned: true, // é—œéµï¼šçµ•å°å®šä½ç¢ºä¿å°é½Š
                    clipPath: null // ä¸€é–‹å§‹æ²’æœ‰ clipPathï¼Œæ‰€ä»¥æ•´å¼µåœ–é¡¯ç¤º? ä¸ï¼Œæˆ‘å€‘è¦æ§åˆ¶å®ƒ
                });
                // ç‚ºäº†è®“å®ƒä¸€é–‹å§‹ã€Œä¸é¡¯ç¤ºã€ï¼Œæˆ‘å€‘çµ¦å®ƒä¸€å€‹ç©ºçš„ clipPath æˆ–è€…å…ˆä¸åŠ åˆ°ç•«å¸ƒ
                // ç­–ç•¥ï¼šå°‡ topLayer åŠ åˆ°ç•«å¸ƒæœ€ä¸Šå±¤ï¼Œä½† clipPath æ˜¯ç©ºçš„ Group (ä»€éº¼éƒ½æ²’æœ‰) -> æ‰€ä»¥ä»€éº¼éƒ½ä¸é¡¯ç¤º? 
                // ä¿®æ­£ï¼šclipPath å¦‚æœæ˜¯ç©ºçš„ï¼Œå¯èƒ½æœƒé¡¯ç¤ºå…¨åœ–ã€‚
                // æˆ‘å€‘ä½¿ç”¨ä¸€å€‹ã€Œç©ºã€çš„ group ä½œç‚º clipPath
                
                maskGroup = new fabric.Group([], { absolutePositioned: true });
                topLayer.clipPath = maskGroup;
                
                canvas.add(topLayer);
                canvas.renderAll();
            });
        }

        // 3. æ–‡å­—åŠŸèƒ½
        function addText() {
            const t = new fabric.IText('é›™æ“Šç·¨è¼¯', {
                left: canvas.width/2 - 60, top: canvas.height/2,
                fontFamily: 'Noto Sans TC',
                fill: '#ffffff', fontSize: 50, fontWeight: '900',
                shadow: 'rgba(0,0,0,0.5) 5px 5px 5px'
            });
            canvas.add(t);
            canvas.setActiveObject(t);
            
            // ç¢ºä¿æ–‡å­—åœ¨ topLayer ä¹‹ä¸‹
            if(topLayer) canvas.bringToFront(topLayer);
        }

        // æ–‡å­—å±¬æ€§ç¶å®š
        const iptText = document.getElementById('ipt-text');
        const iptColor = document.getElementById('ipt-color');
        const iptOpacity = document.getElementById('ipt-opacity');

        function updateUI() {
            const obj = canvas.getActiveObject();
            if(obj && obj.type === 'i-text') {
                iptText.value = obj.text;
                iptColor.value = obj.fill;
                iptOpacity.value = obj.opacity;
            }
        }
        canvas.on('selection:created', updateUI);
        canvas.on('selection:updated', updateUI);
        
        iptText.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({text: iptText.value}); canvas.requestRenderAll(); }};
        iptColor.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({fill: iptColor.value}); canvas.requestRenderAll(); }};
        iptOpacity.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({opacity: parseFloat(iptOpacity.value)}); canvas.requestRenderAll(); }};

        // 4. é®ç½©æ¨¡å¼èˆ‡ç¹ªåœ–é‚è¼¯
        let isMaskMode = false;

        function setMode(mode) {
            isMaskMode = (mode === 'mask');
            
            // UI åˆ‡æ›
            document.getElementById('tab-text').className = isMaskMode ? "flex-1 py-3 text-sm text-gray-500 font-bold transition-all" : "flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold transition-all";
            document.getElementById('tab-mask').className = isMaskMode ? "flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold transition-all" : "flex-1 py-3 text-sm text-gray-500 font-bold transition-all";
            document.getElementById('panel-text').className = isMaskMode ? "hidden" : "flex-1 p-4 space-y-4 overflow-y-auto";
            document.getElementById('panel-mask').className = isMaskMode ? "flex-1 p-4 space-y-4 flex flex-col items-center" : "hidden";

            if (isMaskMode) {
                // é€²å…¥é®ç½©æ¨¡å¼ï¼šé–‹å•Ÿç¹ªåœ–
                canvas.discardActiveObject();
                canvas.requestRenderAll();
                canvas.isDrawingMode = true;
                
                // è¨­å®šç­†
