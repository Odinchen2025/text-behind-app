<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>文字遮罩編輯器 V1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body { touch-action: none; background-color: #0f172a; color: white; overflow: hidden; }
        .canvas-container { margin: 0 auto !important; touch-action: none; }
        .active-mode { background-color: #3b82f6 !important; color: white; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="p-4 flex justify-between items-center bg-slate-800 shadow-md">
        <h1 class="text-sm font-bold tracking-widest">LAYER MASK EDITOR</h1>
        <button id="exportBtn" class="bg-emerald-600 px-4 py-1 rounded text-xs">導出</button>
    </header>

    <main class="flex-1 relative overflow-hidden flex items-center justify-center bg-black">
        <canvas id="editorCanvas"></canvas>
    </main>

    <div class="bg-slate-800 p-4 space-y-4 pb-8">
        <div class="flex gap-2">
            <input type="text" id="textInput" placeholder="輸入文字..." class="flex-1 bg-slate-700 p-2 rounded text-sm outline-none border border-slate-600">
            <input type="color" id="textColor" value="#ffffff" class="w-10 h-10 bg-transparent cursor-pointer">
        </div>

        <div class="flex gap-2">
            <button id="moveBtn" class="flex-1 py-3 rounded-lg bg-slate-700 text-xs font-bold active-mode">移動 / 縮放</button>
            <button id="maskBtn" class="flex-1 py-3 rounded-lg bg-slate-700 text-xs font-bold">塗抹消除 (遮罩)</button>
        </div>

        <label class="block w-full text-center py-2 border border-dashed border-slate-500 rounded text-xs text-slate-400">
            上傳底圖
            <input type="file" id="imageUpload" accept="image/*" class="hidden">
        </label>
    </div>

    <script>
        const canvas = new fabric.Canvas('editorCanvas', {
            width: window.innerWidth,
            height: window.innerWidth, // 預設正方形，上傳照片後會更新
            isDrawingMode: false
        });

        let mainText = null;
        let bgImage = null;

        // 1. 上傳照片
        document.getElementById('imageUpload').onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    // 自動調整畫布比例以符合照片
                    const ratio = img.width / img.height;
                    const displayWidth = window.innerWidth;
                    const displayHeight = displayWidth / ratio;
                    
                    canvas.setWidth(displayWidth);
                    canvas.setHeight(displayHeight);
                    
                    img.set({
                        scaleX: displayWidth / img.width,
                        scaleY: displayWidth / img.width,
                        selectable: false,
                        evented: false
                    });
                    canvas.clear();
                    canvas.add(img);
                    bgImage = img;
                    if(mainText) canvas.add(mainText);
                });
            };
            reader.readAsDataURL(file);
        };

        // 2. 文字輸入與同步
        document.getElementById('textInput').oninput = function(e) {
            const val = e.target.value;
            if (!mainText) {
                mainText = new fabric.Text(val, {
                    left: 50,
                    top: 50,
                    fontSize: 40,
                    fill: document.getElementById('textColor').value,
                    cornerSize: 24, // 讓手機好操作
                    transparentCorners: false
                });
                canvas.add(mainText);
            } else {
