<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Text Mask Tool V6 (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    
    <style>
        /* åŸºç¤è¨­å®š */
        body { background-color: #000; color: white; touch-action: none; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        
        /* ç•«å¸ƒå®¹å™¨ï¼šé è¨­çµ¦ä¸€å€‹é«˜åº¦ï¼Œé¿å…å¡Œé™· */
        #canvas-wrapper { 
            position: relative; width: 100vw; height: 60vh; 
            background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        /* è¼‰å…¥å‹•ç•«å±¤ - é è¨­æ¨£å¼ */
        #loading-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #444; border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ§åˆ¶é¢æ¿ */
        .controls { height: 40vh; background: #222; display: flex; flex-direction: column; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 14px; color: #666; border-bottom: 2px solid #333; transition: 0.2s; }
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; font-weight: bold; background: #2a2a2a; }

        input[type=range] { -webkit-appearance: none; background: transparent; height: 30px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; box-shadow: 0 2px 4px black; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loading-layer" style="display: none;">
        <div class="spinner"></div>
        <div id="loading-text" class="text-gray-300 font-bold text-sm">è™•ç†ä¸­...</div>
    </div>

    <div class="flex justify-between items-center px-4 py-3 bg-gray-900 border-b border-gray-800 z-50">
        <span class="font-bold text-gray-400 text-sm">TEXT MASK V6</span>
        <div class="flex gap-2">
            <label class="bg-blue-600 active:bg-blue-700 px-4 py-1.5 rounded text-xs font-bold transition cursor-pointer flex items-center shadow-lg text-white">
                ğŸ“‚ é–‹å•Ÿç…§ç‰‡
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </label>
            <button onclick="saveImage()" class="bg-gray-700 active:bg-gray-600 px-4 py-1.5 rounded text-xs font-bold transition text-white">ğŸ’¾ å­˜åœ–</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="c"></canvas>
    </div>

    <div class="controls">
        <div class="flex">
            <div id="tab-text" onclick="switchMode('text')" class="tab-btn active">1. æ–‡å­—ç·¨è¼¯</div>
            <div id="tab-mask" onclick="switchMode('mask')" class="tab-btn">2. äººç‰©é®ç½©</div>
        </div>

        <div id="panel-text" class="flex-1 p-4 overflow-y-auto space-y-4">
            <button onclick="addText()" class="w-full bg-gray-700 py-3 rounded text-sm font-bold border border-gray-600 active:bg-gray-600 text-white">+ æ–°å¢æ–‡å­—</button>
            <div class="space-y-3">
                <input type="text" id="val-text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white text-center" placeholder="è¼¸å…¥æ–‡å­—">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">é¡è‰²</span>
                    <input type="color" id="val-color" class="w-10 h-10 rounded bg-transparent border-none">
                    <span class="text-xs text-gray-500 ml-2">é€æ˜åº¦</span>
                    <input type="range" id="val-opacity" min="0" max="1" step="0.1" value="1" class="flex-1">
                </div>
            </div>
        </div>

        <div id="panel-mask" class="hidden flex-1 p-4 flex flex-col items-center">
            <div class="text-blue-300 text-xs text-center mb-4 px-4 py-2 bg-blue-900/20 rounded border border-blue-900/50">
                ğŸ‘† å¡—æŠ¹<b>äººç‰©å€åŸŸ</b><br><span class="text-gray-500">(è¢«å¡—æŠ¹çš„äººç‰©å°‡æœƒè“‹åœ¨æ–‡å­—ä¸Šæ–¹)</span>
            </div>
            <div class="flex gap-3 w-full mb-4 px-2">
                <button onclick="undoMask()" class="flex-1 bg-gray-700 py-3 rounded text-sm font-bold text-white">â†©ï¸ æ’¤éŠ·</button>
                <button onclick="resetMask()" class="flex-1 bg-red-900/40 text-red-200 border border-red-900/50 py-3 rounded text-sm font-bold">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div class="w-full px-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>ç­†åˆ·å¤§å°</span>
                    <span id="brush-size-val">30</span>
                </div>
                <input type="range" id="val-brush" min="10" max="100" value="30">
            </div>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // 1. å®‰å…¨å•Ÿå‹•æª¢æŸ¥ (ç¢ºä¿ Fabric.js å·²è¼‰å…¥)
        // -----------------------------------------------------------
        let canvas;
        
        window.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥ Fabric æ˜¯å¦å­˜åœ¨
            if (typeof fabric === 'undefined') {
                alert("éŒ¯èª¤ï¼šFabric.js å‡½å¼åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡æ–°æ•´ç†ã€‚");
                return;
            }
            initApp();
        });

        // å…¨åŸŸè®Šæ•¸
        let bgImage = null;
        let topMaskLayer = null;
        let maskPaths = [];
        let isMaskMode = false;
        
        // è¼‰å…¥æç¤ºæ§åˆ¶
        const loadingEl = document.getElementById('loading-layer');
        const loadingText = document.getElementById('loading-text');

        function showLoading(msg) {
            loadingText.innerText = msg || "è™•ç†ä¸­...";
            loadingEl.style.display = 'flex'; // ç”¨ JS å¼·åˆ¶é¡¯ç¤º
        }

        function hideLoading() {
            loadingEl.style.display = 'none'; // ç”¨ JS å¼·åˆ¶éš±è—
        }

        function initApp() {
            // åˆå§‹åŒ–ç•«å¸ƒ
            const wrapper = document.getElementById('canvas-wrapper');
