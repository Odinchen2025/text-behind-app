<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Text Mask Tool V7 (Performance)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; touch-action: none; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        #canvas-wrapper { position: relative; width: 100vw; height: 60vh; background: #111; display: flex; justify-content: center; align-items: center; }
        #loading-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #444; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .controls { height: 40vh; background: #222; display: flex; flex-direction: column; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 14px; color: #666; border-bottom: 2px solid #333; }
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; font-weight: bold; background: #2a2a2a; }
        input[type=range] { -webkit-appearance: none; background: transparent; height: 30px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loading-layer">
        <div class="spinner"></div>
        <div id="loading-text" class="text-gray-300 font-bold text-sm">æ­£åœ¨å£“ç¸®ç…§ç‰‡...</div>
    </div>

    <div class="flex justify-between items-center px-4 py-3 bg-gray-900 border-b border-gray-800 z-50">
        <span class="font-bold text-gray-400 text-sm">TEXT MASK V7</span>
        <div class="flex gap-2">
            <label class="bg-blue-600 px-4 py-1.5 rounded text-xs font-bold cursor-pointer text-white">
                ğŸ“‚ é–‹å•Ÿç…§ç‰‡
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </label>
            <button onclick="saveImage()" class="bg-gray-700 px-4 py-1.5 rounded text-xs font-bold text-white">ğŸ’¾ å­˜åœ–</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="c"></canvas>
    </div>

    <div class="controls">
        <div class="flex">
            <div id="tab-text" onclick="switchMode('text')" class="tab-btn active">1. æ–‡å­—ç·¨è¼¯</div>
            <div id="tab-mask" onclick="switchMode('mask')" class="tab-btn">2. äººç‰©é®ç½©</div>
        </div>
        <div id="panel-text" class="flex-1 p-4 space-y-4">
            <button onclick="addText()" class="w-full bg-gray-700 py-3 rounded text-sm font-bold text-white">+ æ–°å¢æ–‡å­—</button>
            <input type="text" id="val-text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white text-center" placeholder="è¼¸å…¥æ–‡å­—å…§å®¹">
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">é¡è‰²</span>
                <input type="color" id="val-color" class="w-10 h-10 rounded bg-transparent border-none">
                <span class="text-xs text-gray-500 ml-2">é€æ˜åº¦</span>
                <input type="range" id="val-opacity" min="0" max="1" step="0.1" value="1" class="flex-1">
            </div>
        </div>
        <div id="panel-mask" class="hidden flex-1 p-4 flex flex-col items-center">
            <div class="flex gap-3 w-full mb-4 px-2">
                <button onclick="undoMask()" class="flex-1 bg-gray-700 py-3 rounded text-sm font-bold text-white">â†©ï¸ æ’¤éŠ·</button>
                <button onclick="resetMask()" class="flex-1 bg-red-900/40 text-red-200 py-3 rounded text-sm font-bold">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div class="w-full px-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1"><span>ç­†åˆ·å¤§å°</span><span id="brush-size-val">30</span></div>
                <input type="range" id="val-brush" min="10" max="100" value="30">
            </div>
        </div>
    </div>

    <script>
        let canvas, bgImage, topMaskLayer, maskPaths = [], isMaskMode = false;
        const loadingLayer = document.getElementById('loading-layer');

        window.onload = () => {
            const wrapper = document.getElementById('canvas-wrapper');
            canvas = new fabric.Canvas('c', { backgroundColor: '#111', width: wrapper.clientWidth, height: wrapper.clientHeight, selection: false });
        };

        // æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–ä¸¦å¼·åˆ¶é å£“ç¸®åœ–ç‰‡
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            loadingLayer.style.display = 'flex';

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // å»ºç«‹ä¸€å€‹éš±è—çš„ Canvas é€²è¡Œé™å£“
                    const offscreenCanvas = document.createElement('canvas');
                    const maxDim = 1500; // æœ€å¤§é‚Šé•·é™åˆ¶
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }

                    offscreenCanvas.width = width;
                    offscreenCanvas.height = height;
                    const ctx = offscreenCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // å°‡ç¸®å°å¾Œçš„åœ–ç‰‡è½‰å› Fabric
                    fabric.Image.fromURL(offscreenCanvas.toDataURL('image/jpeg', 0.8), (fImg) => {
                        canvas.clear();
                        maskPaths = [];
                        const scale = Math.min(canvas.width / fImg.width, canvas.height / fImg.height);
                        fImg.set({ originX: 'center', originY: 'center', left: canvas.width / 2, top: canvas.height / 2, scaleX: scale, scaleY: scale, selectable: false, evented: false });
                        bgImage = fImg;
                        canvas.add(bgImage);

                        bgImage.clone((cloned) => {
                            topMaskLayer = cloned;
                            topMaskLayer.set({ selectable: false, evented: false, absolutePositioned: true, clipPath: new fabric.Group([], { absolutePositioned: true }) });
                            canvas.add(topMaskLayer);
                            addText();
                            loadingLayer.style.display = 'none';
                        });
                    });
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        function addText() {
            const t = new fabric.IText('é»æˆ‘ç·¨è¼¯', { left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center', fontFamily: 'Noto Sans TC', fill: '#ffffff', fontSize: 60, fontWeight: '900' });
            canvas.add(t);
            canvas.setActiveObject(t);
            if(topMaskLayer) canvas.bringToFront(topMaskLayer);
        }

        // UI èˆ‡ é®ç½©é‚è¼¯ (ç°¡åŒ–ä»¥æå‡æ•ˆèƒ½)
        document.getElementById('val-text').oninput = (e) => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set('text', e.target.value); canvas.renderAll(); }};
        document.getElementById('val-color').oninput = (e) => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set('fill', e.target.value); canvas.renderAll(); }};
        document.getElementById('val-opacity').oninput = (e) => { const o = canvas.getActiveObject(); if(o && o.type==='i-text'){ o.set('opacity', parseFloat(e.target.value)); canvas.renderAll(); }};
        document.getElementById('val-brush').oninput = (e) => { document.getElementById('brush-size-val').innerText = e.target.value; if(canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = parseInt(e.target.value); };

        function switchMode(mode) {
            isMaskMode = (mode === 'mask');
            document.getElementById('tab-text').className = isMaskMode ? 'tab-btn' : 'tab-btn active';
            document.getElementById('tab-mask').className = isMaskMode ? 'tab-btn active' : 'tab-btn';
            document.getElementById('panel-text').className = isMaskMode ? 'hidden' : 'flex-1 p-4 space-y-4';
            document.getElementById('panel-mask').className = isMaskMode ? 'flex-1 p-4 flex flex-col items-center' : 'hidden';
            canvas.isDrawingMode = isMaskMode;
            if(isMaskMode) {
                canvas.discardActiveObject().renderAll();
                const brush = new fabric.PencilBrush(canvas);
                brush.color = "rgba(255, 50, 50, 0.5)";
                brush.width = parseInt(document.getElementById('val-brush').value);
                canvas.freeDrawingBrush = brush;
            }
        }

        setTimeout(() => {
            canvas.on('path:created', (e) => {
                if (!isMaskMode) return;
                const path = e.path;
                canvas.remove(path);
                path.clone((cloned) => {
                    cloned.set({ stroke: 'black', fill: null, strokeWidth: path.strokeWidth, strokeLineCap: 'round', strokeLineJoin: 'round', left: path.left, top: path.top });
                    maskPaths.push(cloned);
                    const group = new fabric.Group(maskPaths, { absolutePositioned: true });
                    topMaskLayer.clipPath = group;
                    canvas.renderAll();
                });
            });
        }, 1000);

        function undoMask() { if (maskPaths.length > 0) { maskPaths.pop(); applyMask(); } }
        function resetMask() { maskPaths = []; applyMask(); }
        function applyMask() { topMaskLayer.clipPath = new fabric.Group(maskPaths, { absolutePositioned: true }); canvas.renderAll(); }
        function saveImage() { canvas.discardActiveObject().renderAll(); const link = document.createElement('a'); link.href = canvas.toDataURL({ format: 'png', multiplier: 2 }); link.download = 'TextBehind.png'; link.click(); }
    </script>
</body>
</html>
