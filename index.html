<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Text Behind Image Tool v3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; touch-action: none; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        #canvas-area { 
            position: relative; width: 100vw; height: 55vh; 
            background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        /* è¼‰å…¥é®ç½© */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; justify-content: center; align-items: center;
            color: #3b82f6; font-weight: bold; font-size: 1.2rem;
        }
        .controls { height: 45vh; background: #222; display: flex; flex-direction: column; padding-bottom: 20px;}
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4b5563; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loading-overlay" class="hidden">
        <span>âŸ³ è™•ç†ç…§ç‰‡ä¸­...</span>
    </div>

    <div class="flex justify-between items-center p-3 bg-gray-900 border-b border-gray-800 z-50">
        <span class="font-bold text-gray-400 text-sm">TEXT MASK v3</span>
        <div class="flex gap-2">
            <label class="bg-gray-700 px-3 py-1.5 rounded text-xs font-bold active:scale-95 transition cursor-pointer flex items-center gap-1">
                ğŸ“‚ é–‹å•Ÿç…§ç‰‡
                <input type="file" id="up-img" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImg()" class="bg-blue-600 px-3 py-1.5 rounded text-xs font-bold active:scale-95 transition">ğŸ’¾ å­˜åœ–</button>
        </div>
    </div>

    <div id="canvas-area">
        <canvas id="c"></canvas>
    </div>

    <div class="controls">
        <div class="flex text-center border-b border-gray-700">
            <div id="tab-text" onclick="setMode('text')" class="flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold transition-all">A. æ–‡å­—ç·¨è¼¯</div>
            <div id="tab-mask" onclick="setMode('mask')" class="flex-1 py-3 text-sm text-gray-500 font-bold transition-all">B. é®ç½©å¡—æŠ¹</div>
        </div>

        <div id="panel-text" class="flex-1 p-4 space-y-4 overflow-y-auto">
            <button onclick="addText()" class="bg-gray-700 w-full py-3 rounded-lg text-sm font-bold active:bg-gray-600">+ æ–°å¢æ–‡å­—</button>
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <span class="text-xs w-8 text-gray-400">å…§å®¹</span>
                    <input type="text" id="ipt-text" class="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm" placeholder="è¼¸å…¥æ–‡å­—">
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs w-8 text-gray-400">é¡è‰²</span>
                    <input type="color" id="ipt-color" class="w-8 h-8 rounded border-none bg-transparent">
                    <span class="text-xs w-8 text-gray-400 ml-2">é€æ˜</span>
                    <input type="range" id="ipt-opacity" min="0" max="1" step="0.1" value="1" class="flex-1">
                </div>
            </div>
        </div>

        <div id="panel-mask" class="hidden flex-1 p-4 space-y-4 flex flex-col items-center">
            <div class="bg-yellow-900/30 text-yellow-500 p-2 rounded text-xs w-full text-center border border-yellow-800">
                ğŸ‘† ç”¨æ‰‹æŒ‡å¡—æŠ¹<b>ã€Œäººç‰©ã€</b> (æœƒé¡¯ç¤ºç´…è‰²é è¦½)
            </div>
            <div class="flex gap-4 w-full justify-center">
                <button onclick="undoMask()" class="flex-1 bg-gray-700 py-3 rounded-lg text-sm font-bold active:scale-95">â†©ï¸ æ’¤éŠ·</button>
                <button onclick="clearMask()" class="flex-1 bg-red-900/50 text-red-300 py-3 rounded-lg text-sm font-bold active:scale-95">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div class="w-full pt-2">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>ç­†åˆ·å¤§å°</span>
                    <span id="brush-val">30</span>
                </div>
                <input type="range" id="ipt-brush" min="5" max="80" value="30" class="w-full">
            </div>
        </div>
    </div>

    <script>
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        const loader = document.getElementById('loading-overlay');
        function showLoading(show) {
            loader.classList.toggle('hidden', !show);
        }

        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#111',
            preserveObjectStacking: true,
            selection: false
        });

        let bgImgNode = null; 
        let topLayer = null;  
        let maskPaths = [];
        
        // è¢å¹•é©é…
        function resize() {
            const container = document.getElementById('canvas-area');
            if(container.clientWidth > 0 && container.clientHeight > 0){
                 canvas.setWidth(container.clientWidth);
                 canvas.setHeight(container.clientHeight);
            }
        }
        window.addEventListener('resize', resize);
        // å»¶é²åŸ·è¡Œä¸€æ¬¡ä»¥ç¢ºä¿ CSS è¼‰å…¥å®Œç•¢
        setTimeout(resize, 100);

        // 1. ä¸Šå‚³ç…§ç‰‡ (ä¿®å¾©é»‘å±é—œéµé‚è¼¯)
        document.getElementById('up-img').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            showLoading(true);

            const reader = new FileReader();
            reader.onload = (f) => {
                const imgObj = new Image();
                imgObj.src = f.target.result;
                imgObj.onload = function() {
                    // å‰µå»º Fabric åœ–ç‰‡
                    const imgInstance = new fabric.Image(imgObj);
                    
                    canvas.clear();
                    maskPaths = [];
                    canvas.setBackgroundColor('#111', canvas.renderAll.bind(canvas)); // å¼·åˆ¶é‡ç¹ªèƒŒæ™¯

                    // è¨ˆç®—ç¸®æ”¾ (é™åˆ¶æœ€å¤§å¯¬åº¦ä»¥é˜²é»‘å±)
                    const maxDim = 1500; // æ‰‹æ©Ÿå®‰å…¨é™åˆ¶
                    if (imgInstance.width > maxDim || imgInstance.height > maxDim) {
                        imgInstance.scaleToWidth(maxDim);
                    }

                    // ç•«å¸ƒé©é…
                    const scale = Math.min(
                        canvas.width / (imgInstance.width * imgInstance.scaleX), 
                        canvas.height / (imgInstance.height * imgInstance.scaleY)
                    );
                    
                    // å¦‚æœ scale æ˜¯ Infinity (ç•«å¸ƒæœªåˆå§‹åŒ–), çµ¦å€‹é è¨­å€¼
                    const finalScale = isFinite(scale) ? scale : 0.5;

                    imgInstance.set({
                        scaleX: imgInstance.scaleX * finalScale,
                        scaleY: imgInstance.scaleY * finalScale,
                        originX: 'center', 
                        originY: 'center',
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        selectable: false,
                        evented: false
                    });

                    bgImgNode = imgInstance;
                    canvas.add(bgImgNode);
                    canvas.renderAll();
                    
                    // å»¶é²å»ºç«‹é ‚å±¤é®ç½©ï¼Œé¿å…å¡é “
                    setTimeout(() => {
                        initTopLayer();
                        showLoading(false);
                    }, 100);
                };
                
                imgObj.onerror = function() {
                    alert("åœ–ç‰‡è®€å–å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µè©¦è©¦");
                    showLoading(false);
                }
            };
            reader.readAsDataURL(file);
        };

        // 2. å»ºç«‹é®ç½©å±¤
        function initTopLayer() {
            if(!bgImgNode) return;
            bgImgNode.clone((cloned) => {
                topLayer = cloned;
                topLayer.set({
                    selectable: false, evented: false, absolutePositioned: true,
                    clipPath: new fabric.Group([], { absolutePositioned: true }) 
                });
                canvas.add(topLayer);
                canvas.requestRenderAll();
            });
        }

        // 3. æ–‡å­—åŠŸèƒ½
        function addText() {
            if (!bgImgNode) { alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡ï¼"); return; }
            const t = new fabric.IText('é›™æ“Šç·¨è¼¯', {
                left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center',
                fontFamily: 'Noto Sans TC', fill: '#ffffff', fontSize: 60, fontWeight: '900',
                shadow: 'rgba(0,0,0,0.5) 5px 5px 5px'
            });
            canvas.add(t);
            canvas.setActiveObject(t);
            if(topLayer) canvas.bringToFront(topLayer);
        }

        // æ–‡å­— UI é€£å‹•
        const iptText = document.getElementById('ipt-text');
        const iptColor = document.getElementById('ipt-color');
        const iptOpacity = document.getElementById('ipt-opacity');

        function updateUI() {
            const obj = canvas.getActiveObject();
            if(obj && obj.type === 'i-text') {
                iptText.value = obj.text;
                iptColor.value = obj.fill;
                iptOpacity.value = obj.opacity;
            }
        }
        canvas.on('selection:created', updateUI);
        canvas.on('selection:updated', updateUI);
        iptText.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({text: iptText.value}); canvas.requestRenderAll(); }};
        iptColor.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({fill: iptColor.value}); canvas.requestRenderAll(); }};
        iptOpacity.oninput = () => { const o = canvas.getActiveObject(); if(o) { o.set({opacity: parseFloat(iptOpacity.value)}); canvas.requestRenderAll(); }};

        // 4. é®ç½©æ¨¡å¼
        let isMaskMode = false;
        function setMode(mode) {
            isMaskMode = (mode === 'mask');
            document.getElementById('tab-text').className = isMaskMode ? "flex-1 py-3 text-sm text-gray-500 font-bold" : "flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold";
            document.getElementById('tab-mask').className = isMaskMode ? "flex-1 py-3 text-sm text-blue-400 border-b-2 border-blue-400 font-bold" : "flex-1 py-3 text-sm text-gray-500 font-bold";
            document.getElementById('panel-text').className = isMaskMode ? "hidden" : "flex-1 p-4 space-y-4 overflow-y-auto";
            document.getElementById('panel-mask').className = isMaskMode ? "flex-1 p-4 space-y-4 flex flex-col items-center" : "hidden";

            if (isMaskMode) {
                canvas.discardActiveObject();
                canvas.renderAll();
                canvas.isDrawingMode = true;
                const brush = new fabric.PencilBrush(canvas);
                brush.color = "rgba(255, 0, 0, 0.5)"; // ç´…è‰²é è¦½
                brush.width = parseInt(document.getElementById('ipt-brush').value);
                canvas.freeDrawingBrush = brush;
                canvas.forEachObject(o => { o.selectable = false; });
            } else {
                canvas.isDrawingMode = false;
                canvas.forEachObject(o => { if(o.type === 'i-text') o.selectable = true; });
            }
        }

        document.getElementById('ipt-brush').oninput = (e) => {
            document.getElementById('brush-val').innerText = e.target.value;
            if(canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = parseInt(e.target.value);
        };

        canvas.on('path:created', (e) => {
            if (!isMaskMode) return;
            const path = e.path;
            canvas.remove(path); // ç§»é™¤ç´…è‰²è»Œè·¡
            
            // è½‰ç‚ºé®ç½©
            path.clone((cloned) => {
                cloned.set({
                    stroke: 'black', fill: null, 
                    strokeWidth: path.strokeWidth, strokeLineCap: 'round', strokeLineJoin: 'round',
                    left: path.left, top: path.top
                });
                maskPaths.push(cloned);
                updateMask();
            });
        });

        function updateMask() {
            if (!topLayer) return;
            const g = new fabric.Group(maskPaths, { absolutePositioned: true, inverted: false });
            topLayer.clipPath = g;
            topLayer.dirty = true;
            canvas.requestRenderAll();
        }

        function undoMask() {
            if(maskPaths.length > 0) { maskPaths.pop(); updateMask(); }
        }
        function clearMask() {
            maskPaths = []; updateMask();
        }

        // 5. ä¸‹è¼‰
        function downloadImg() {
            if (!bgImgNode) return;
            // æš«æ™‚éš±è—æ§åˆ¶é …é€²è¡Œæˆªåœ–
            canvas.discardActiveObject();
            canvas.renderAll();
            
            // é‡å°æ‰‹æ©Ÿé«˜è§£æåº¦è¼¸å‡º
            const pixelRatio = window.devicePixelRatio || 1;
            const data = canvas.toDataURL({ format: 'png', quality: 0.9, multiplier: 2 });
            
            const link = document.createElement('a');
            link.href = data;
            link.download = 'text-mask-edit.png';
            link.click();
        }
    </script>
</body>
</html>
